<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <!-- import Vue before Element -->
    <link rel="icon" href="/web/statics/favicon.ico">
    <script src="https://unpkg.com/vue@2.7.14/dist/vue.js"></script>
    <script>Vue.config.productionTip = false</script>
    <!-- import JavaScript -->
    <script src="https://unpkg.com/element-ui@2.15.12/lib/index.js"></script>
    <script src="https://unpkg.com/axios@1.2.2/dist/axios.min.js"></script>
    <!-- <script src="/web/js/request.js" type="module"></script> -->
    <!-- import CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.15.12/lib/theme-chalk/index.css">
    <link rel="stylesheet" href="/web/css/style.css">
</head>

<body>
    <el-container >
        <el-header style="text-align:center; font-size: 18px;">
            <div id="app">
                <el-row type="flex" class="row-bg" justify="center">
                    <el-col :span="2">
                        <div class="grid-content"><el-button type="text" icon="el-icon-s-home"
                                @click=changeRouter("home")>Home</el-button></div>
                    </el-col>
                    <el-col :span="2" :offset=13>
                        <div class="grid-content "><el-button type="text" icon="el-icon-key"
                                @click=changeRouter("secret")>Keys</el-button></div>
                    </el-col>
                    <el-col :span="2">
                        <div class="grid-content"><el-button type="text" icon="el-icon-s-promotion"
                            @click=changeRouter("transport")>Share</el-button></div>
                    </el-col>
                    <el-col :span="2">
                        <div class="grid-content"
                        ><el-button type="text" icon="el-icon-search"
                        @click=changeRouter("find")
                            >Query</el-button></div>
                    </el-col>
                    <!-- open blockchain browser -->
                    <el-col :span="2">
                        <div class="grid-content"><el-button type="text" icon="el-icon-discover" @click="openBloBro">Blockchain network</el-button>
                        </div>
                    </el-col>
                </el-row>
                
        </el-header>
        
        <el-main v-show="this.router=='home'">
            <div class="texthome">
                <h1 style="height: 100px;color: #409EFF;">Blockchain-IPFS based data sharing plaform</h1>
                <p style="color:#909399;text-indent:37px ; text-align: left;">This system employs the RSA algorithm to generate key pairs.
                     The RSA private key is utilized for user authentication, with the data transmitted by the user stored in IPFS. 
                     The CID (IPFS Hash) returned by IPFS is encrypted with the user's RSA private key 
                     and stored in the blockchain. The blockchain component leverages Hyperledger Fabric 
                     and utilizes Hyperledger Explorer to track transactions.</p>
            </div>
            <el-row>
                <!-- <el-col :span="4" :offset=3> -->
                <div style="width: 1230px;margin: auto;" >
                <el-col style="width: 270px;" >
                    <el-card :body-style="{ padding: '0px' }" shadow="hover" >
                        <img src="/web/statics/keys.jpeg" class="image"  >
                        <div style="padding:14px 14px 0px 14px;">
                            <div class="cardtext">
                                <span>Using 1024-bites RSA Keys to encrypt your sharing, ensuring
                                    the safety of your shared files and transmission process.</span>
                            </div>
                            <div class="bottom clearfix" style="border-top: #eaeefb;border-top-width: 1px;border-top-style: solid;" @click="changeRouter('secret')">
                                <el-button type="text" class="button" >Generate Keys Now</el-button>
                            </div>
                        </div>

                    </el-card>
                </el-col>
                <el-col style="width: 320px;padding-left: 50px;" >
                    <el-card :body-style="{ padding: '0px' }" shadow="hover">
                        <img src="/web/statics/send.jpeg" class="image">
                        <div style="padding:14px 14px 0px 14px;">
                            <div class="cardtext">
                                <span>Share your files on IPFS network and record on the blockchain network.
                                    You can check it at any time with any device.</span>
                            </div>
                            <div class="bottom clearfix" style="border-top: #eaeefb;border-top-width: 1px;border-top-style: solid;"@click="changeRouter('transport')">
                                <el-button type="text" class="button" >Try Sharing Now</el-button>
                            </div>
                        </div>
                    </el-card>
                </el-col>
                <el-col style="width: 320px;padding-left: 50px;" >
                    <el-card :body-style="{ padding: '0px' }" shadow="hover">
                        <img src="/web/statics/search.jpeg" class="image" >
                        <div style="padding:14px 14px 0px 14px;">
                            <div class="cardtext" >
                                <span>You can query the files shared with you andn download them. 
                                    Records on the blockchain network are also avaliable.</span>
                            </div>
                            <div class="bottom clearfix" style="border-top: #eaeefb;border-top-width: 1px;border-top-style: solid;" @click="changeRouter('find')">
                                <el-button type="text" class="button" >Query Now</el-button>
                            </div>
                        </div>

                    </el-card>
                </el-col>
                <el-col style="width: 320px;padding-left: 50px;" >
                    <el-card :body-style="{ padding: '0px' }" shadow="hover">
                        <img src="/web/statics/blockchain.jpeg" class="image">
                        <div style="padding:14px 14px 0px 14px;">
                            <div class="cardtext">
                                <span>The use of blockchain browsers allows users to conveniently search for transaction details, including timestamps, endorsements, etc. 
                                    </span>
                            </div>
                            <div class="bottom clearfix" style="border-top: #eaeefb;border-top-width: 1px;border-top-style: solid;" @click="openBloBro">
                                <el-button type="text" class="button" >Blockchain network</el-button>
                            </div>
                        </div>
                    </el-card>
                </el-col>
                </div>
            </el-row>
        </el-main>
        <el-main v-show="this.router=='secret'">
            <img src="/web/statics/keys.jpeg" alt="" style="height: 200px;margin: 30px;">
            <h1 style="color: #606266;margin-bottom: 30px;">RSA Keys Generations</h1>
            <el-button type="primary" @click="getRSAKey">Generate key pairs</el-button>
            <el-button type="primary" @click="restoreRSApk">Recovery public key</el-button>
            <el-dialog :visible.sync="rsa.dialogVisible_gen" width="50%" :data="rsa" fullscreen="">
                <div style="width: 50%;margin: auto;">
                <h2 style="color:#F56C6C;">RSA private key, please do not tell others:</h2>
                <span style="font-size:smaller;color:#F56C6C;">{{rsa.sk}}</span>
                <h2 style="color:#67C23A;margin-top: 50px;">RSA public key, only use in sending files:</h2>
                <span style="font-size: smaller;color: #67C23A;">{{rsa.pk}}</span>
                <h5>Please note that we will automatically store yout key pairs on the cookie securely.
                    If you don't need, please reject these cookies.
                </h5>
                </div>
                <span slot="footer" class="dialog-footer">
                    <el-button type="primary" @click="cleanKey">Yes</el-button>
                </span>
            </el-dialog>
            <el-dialog title="Please enter private key" :visible.sync="rsa.dialogVisible_restore" width="50%">
                <el-input type="textarea" :rows="11" placeholder="Private key here" v-model="rsa.sk">
                </el-input>
                <span slot="footer" class="dialog-footer">
                    <el-button type="primary" @click="getRSApk()">Recovery</el-button></el-button></el-button>
                </span>
            </el-dialog>
            <el-dialog :visible.sync="rsa.dialogVisible_restore_suc" width="50%">
                <div style="width: 50%;margin: auto;">
                <h2 style="color:#67C23A;margin-top: 50px;">Your RSA public key:</h2>
                <span style="font-size: smaller;color: #67C23A;">{{rsa.pk}}</span>
                </div>
                <span slot="footer" class="dialog-footer">
                    <el-button type="primary"
                        @click="rsa.dialogVisible_restore_suc=false">Yes</el-button></el-button></el-button>
                </span>
            </el-dialog>
        </el-main>
        <el-main v-show="this.router=='transport'">
            <img src="/web/statics/send.jpeg" alt="" height="200px" style="height: 200px;margin: 30px;">
            <div style="width: 400px; margin: auto;">
                <el-form :model="send.sendForm" status-icon ref="send.sendForm" label-width="100px" class="demo-ruleForm"
                    label-position="top" style="text-align: left;"
                    v-loading="loading" element-loading-text="Uploading, please wait...">
                    <el-form-item label="Public Key of Receiver " prop="recevierPk">
                        <el-input v-model="send.sendForm.recevier" type="textarea" :rows="2" v-model="textarea"></el-input>
                    </el-form-item>

                    <el-form-item label="Privacy Key of Sender" prop="senderSk">
                        <el-input v-model="send.sendForm.sender" type="textarea" :rows="2" v-model="textarea"></el-input>
                    </el-form-item>

                    <el-form-item label="Attached message" prop="12312">
                        <el-input v-model="send.sendForm.message" type="textarea" :rows="2" v-model="textarea"></el-input>
                    </el-form-item>

                    <el-form-item>
                        <el-upload class="upload-demo" ref="upload" action="#" :limit="1" :on-exceed="handleExceed"
                            :on-remove="handleRemove" :auto-upload="false">
                            <el-button slot="trigger" size="small" type="primary"
                                style="margin-top: 10px;margin-bottom: 10px;">Choose File</el-button>
                        </el-upload>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="submitForm('send.sendForm')">Submit</el-button>
                        <el-button @click="resetForm('send.sendForm')">Reset</el-button>
                    </el-form-item>
                </el-form>
                <el-dialog :visible.sync="send.sendForm.dialogVisible_txid" width="30%" :data="send.sendForm">
                    <h2 style="color: #67C23A;">ID of Blockchain Transaction</h2>
                    <span>{{send.sendForm.txid}}</span>
                    <span slot="footer" class="dialog-footer">
                        <el-button type="primary" @click="goDetails">Details</el-button></el-button>
                    </span>
                </el-dialog>
            </div>
        </el-main>
        <el-main v-show="this.router=='find'">
            <img src="/web/statics/search.jpeg" alt="" height="200px" style="height: 200px;margin: 30px;">
            <div style="width: 400px;margin: auto;" v-loading="loading" element-loading-text="Querying, please wait...">
                <el-input type="textarea" :rows="2" placeholder="Your Privacy Key！～！" v-model="search.sk" @focus="showAutoFillBox">
                </el-input>

                <div class="auto-fill-container" v-if="showAutoFill">
                    <div class="auto-fill-content">
                        <div v-for="(cookieValue, index) in skCookies" :key="index" class="auto-fill-item">
                            <label class="auto-fill-label">
                                <input type="checkbox" v-model="selectedCookie[index]" @change="fillInput(index, cookieValue)" class="auto-fill-checkbox">
                                <span class="auto-fill-cookie">{{ cookieValue.substring(0, 20) }}</span>
                            </label>
                        </div>
                    </div>
                </div>
                

                <!-- <div class="auto-fill-container" v-if="showAutoFill">
                    <div class="auto-fill-content">
                        <div v-for="(cookieValue,index) in skCookies" :key="index" class="auto-fill-item">
                            <input type="checkbox" v-model="selectedCookie[index]" @change="fillInput(index,cookieValue)" class="auto-fill-radio">{{ cookieValue }}
                        </div>
                    </div>
                </div> -->

                
                <el-button type="primary" plain style="margin: 20px;" @click="getRecords(search.sk)">Query</el-button>
                
            </div>
            <el-dialog
            :visible.sync = search.dialogTableVisible 
            :fullscreen= true
            >
                <el-table :data="search.records" style="width: 80%;margin: auto;" type="index" v-loading="loading" element-loading-text="请求下载中"> 
                    <el-table-column type="expand">
                        <template slot-scope="props">
                            <el-form label-position="left" inline class="demo-table-expand">
                                <el-form-item label="Time:">
                                    <span style="text-align: left;">{{ props.row.timestamp }}</span>
                                </el-form-item>
                                <el-form-item label="Public Key of Transaction">
                                    <span>{{ props.row.sender }} {{props.row.sender==search.pk?"":""}} </span>
                                </el-form-item>
                                <!-- <el-form-item label="Public Key of Receiver">
                                    <span>{{ props.row.receiver }}{{props.row.receiver==search.pk?"（我）":""}}</span>
                                </el-form-item> -->
                                <el-form-item label="Filename">
                                    <span>{{ props.row.filename }}</span>
                                </el-form-item>
                                <el-form-item label="Message">
                                    <span>{{ props.row.message}}{{props.row.message==search.pk?"（me）":""}}</span>
                                </el-form-item>
                                <el-form-item label="ID of Blockchain Transaction">
                                    <span>{{ props.row.txid }}</span>
                                </el-form-item>
                            </el-form>
                        </template>
                    </el-table-column>
                    
                    <el-table-column label="Indedx" type="index">
                    </el-table-column>
                    <el-table-column label="Time" prop="timestamp">
                    </el-table-column>
                    <el-table-column label="Filename" prop="filename">
                    </el-table-column>
                    <el-table-column
                        fixed="right"
                        label="Operation"
                        width="100">
                        <template slot-scope="scope">
                            <el-button @click="searchDownloadlink(scope.row)" type="text" size="small">Download</el-button>
                            <el-button @click="searchDetails(scope.row)" type="text" size="small">Details</el-button>
                        </template>
                    </el-table-column>
                </el-table>
                <span slot="footer" class="dialog-footer-left">
                    <el-button type="primary" @click="printTable">Print list</el-button>
                </span>
                <span slot="footer" class="dialog-footer">
                    <el-button type="primary" @click="search.dialogTableVisible = false">Back Home</el-button>
                </span>
            </el-dialog>

            
        </el-main>
        </div>
    </el-container>
</body>
<script>
    const vm = new Vue({
        el: '#app',
        data: function () {
            return {
                // data of home page
                router: "home",
                loading:false,
                //data of RSAkey page
                rsa: {
                    dialogVisible_gen: false,
                    dialogVisible_restore: false,
                    dialogVisible_restore_suc: false,
                    pk: '',
                    sk: '',
                },
                //data of send page
                send:{
                    sendForm: {
                    'sender': '',
                    'recevier': '',
                    'file': '',
                    'message':'',
                    dialogVisible_txid: false,
                    txid: '正在加载...',
                    },
                    getfiledata: { 'sk': '', filename: '' },

                },
                search: {
                    sk: '',
                    pk: '',
                    records: [],
                    link: '',
                    dialogTableVisible: false
                },
                skCookies:[],
                showAutoFill:false,
                selectedCookie:[],
                //public
                url: 'http://1.14.74.234:9090/',
                blokchainbrowserurl:'http://1.14.74.234:8080/'
            }
        },

        computed: {
            //order records by time
            sortrecords() {
                const arr = vm.search.records
                arr.sort((a, b) => {
                    return b.timestamp - a.timestamp
                })
                return arr
            }
        },

        methods: {
        printTable() {
        window.print();
        },
        printnoTable(){
            const table = this.$refs.table.$el;
            const printWindow = window.open("","blank");
            // Write the table content to the new window
            printWindow.document.write('<html><head><title>Print Table</title></head><body>');
            printWindow.document.write('<h1>Table Content</h1>');
            printWindow.document.write(table.outerHTML);
            printWindow.document.write('</body></html>');
      
            // Print the window
            printWindow.print();
            printWindow.close();
        },
        autoFillSKFromCookie(){
            const cookies = document.cookie.split(';')
            const skCookies = cookies
                .map(cookie => cookie.trim())
                .filter(cookie => cookie.startsWith("sk_"))
                .map(cookie => cookie.split("=")[1]);
            this.skCookies = skCookies;
            console.log("skcookies all: ")
            console.log(skCookies)
        },
        showAutoFillBox(){
            this.autoFillSKFromCookie();
            this.showAutoFill = true;
        },
        fillInput(index,cookieValue){
            // swtich the content
            console.log("fillinput is called")
            console.log(this.selectedCookie)
            console.log(index)
            console.log(this.selectedCookie[index])
            this.$set(this.selectedCookie, index, !this.selectedCookie[index]);
            console.log("-------------------")
            console.log(this.selectedCookie)
            console.log(index)
            console.log(this.selectedCookie[index])
            if (this.selectedCookie[index]) {
                this.search.sk = cookieValue;
            } else {
                this.search.sk = '';
            }
        },

        changeRouter(router){
            vm.router=router
        },

        //methods of home page
        openBloBro(){
            window.open(vm.blokchainbrowserurl)
        },
        changeFixed(clientHeight){ 
        console.log(clientHeight);
        console.log(window.$refs.page.$el.style.height);
        window.$refs.page.$el.style.height = clientHeight-200+'px';
          },
        
        getRandomId(){
            var timestamp = new Date().getTime();
            var randomNumber = Math.floor(Math.random()*100000);
            var uniqueId = timestamp.toString()+randomNumber.toString();
            return uniqueId;
        },

        //methods of RSAkey page
        getRSAKey() {
            // console.log("222")
            axios.get(vm.url+'rsakey').then(
                function (response) {
                    vm.rsa.sk = response.data.sk,
                    vm.rsa.pk = response.data.pk
                    vm.rsa.dialogVisible_gen = true

                    var timestamp = new Date().getTime();
                    var randomNumber = Math.floor(Math.random()*100000);
                    var uniqueId = timestamp.toString()+randomNumber.toString();
                    var id = uniqueId;
                    var expirationDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toUTCString();

                    document.cookie = "sk_" + id + "=" + vm.rsa.sk + ";expires=" + expirationDate + "; path=/";
                    document.cookie = "pk_" + id + "=" + vm.rsa.pk + ";expires=" + expirationDate + "; path=/";

                    // console.log("all cookie:")
                    // console.log(document.cookie);
                }
            ).catch(
                function(response){
                    vm.$message.warning(response.response.data)

                    vm.loading=false}
            )
        },
        restoreRSApk() {
            vm.rsa.sk = '',
            vm.rsa.pk = '',
            vm.rsa.dialogVisible_restore = true
        },
        
        getRSApk() {
            vm.rsa.dialogVisible_restore = false
            axios.post(vm.url + 'rsakeyrestore', { 'sk': vm.rsa.sk }, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            }).then(function (response) {
                vm.rsa.pk = response.data
                vm.rsa.dialogVisible_restore_suc = true;

            }).catch(
                function(response){
                    vm.$message.warning(response.response.data)
                    vm.loading=false}
            )
        },
        cleanKey() {
            vm.rsa.dialogVisible_gen = false,
                vm.rsa.sk = '',
                vm.rsa.pk = ''
        },

        //methods of send page
        submitForm: function () {
            vm.loading=true
            // console.log(vm.send.sendForm.recevier)
            //remove /r /n
            vm.send.sendForm.recevier=vm.send.sendForm.recevier.replace(/\r|\n/ig,"")
            vm.send.sendForm.file = vm.$refs.upload._data.uploadFiles[0].raw
            axios.post(vm.url + 'upload', vm.send.sendForm, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            }).then(
                function (response) {
                    vm.send.sendForm.txid = response.data.txid
                    vm.resetForm()
                    vm.send.sendForm.dialogVisible_txid = true
                }
            ).catch(function(response){
                    vm.$message.warning(response.response.data)
                    vm.loading=false
                },
                // vm.send.sendForm.dialogVisible_txid = false,
            );
        },
        handleExceed() {
            this.$message.warning("Only a file once")
        },
        goDetails: function () {
            window.open(vm.blokchainbrowserurl+"?tab=transactions&transId=" + vm.send.sendForm.txid)
            vm.resetForm()
        },
        resetForm: function () {
            vm.send.sendForm.sender = '',
            vm.send.sendForm.recevier = '',
            vm.send.sendForm.file = '',
            vm.send.sendForm.message = '',
            vm.$refs.upload._data.uploadFiles=[]
            vm.loading=false
        },
        handleRemove(file, fileList) {
        },
        //search
        searchDetails(row){
            window.open(vm.blokchainbrowserurl+"?tab=transactions&transId=" + row.txid)
        },
        searchDownloadlink(row){
            vm.loading=true
            // console.log(row)
            if(vm.search.pk==row.sender){
                console.log(vm.search.sk,row.secid,row.filename)
                vm.getFile(vm.search.sk,row.secid,row.filename)
            }else{
                vm.getFile(vm.search.sk,row.recid,row.filename)
            }
        },
        getFile(sk, ecid, filename) {
            // vm.loading=false
            axios.post(vm.url+'getfile', { 'sk': sk, 'ecid': ecid, 'filename': filename }, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            }).then(function(response){
                console.log(response)
                window.open(response.data)
                vm.loading=false
            })
        },
        getRecords(sk) {
            vm.loading=true
            axios.post(vm.url + 'getrecords', { 'sk': sk }, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            }).then(
                function (response) {
                    vm.search.records = response.data
                    vm.search.dialogTableVisible=true
                    vm.loading=false
                }
            ).catch(
                function(response){
                    vm.$message.warning(response.response.data)
                    vm.loading=false
                }
            )
            axios.post(vm.url+'rsakeyrestore', {'sk':sk},{
            headers: {
                'Content-Type': 'multipart/form-data'
            }
            }).then(function(response){
                    vm.search.pk=response.data
            })

        },
    }
    })


</script>
<script>

</script>

</html>
